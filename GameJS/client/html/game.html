<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" style="background:#000000;">
<head id="Head1" runat="server">
    <title>JS Game</title>
    <link href="../styles/clsDisplayPanel.css" rel="stylesheet" />
    <link href="../styles/clsGround.css" rel="stylesheet" />
</head>
<body onkeydown="keyDownHandler(event)" ondrop="drop(event)" ondragover="allowDrop(event)">
    
</body>
</html>

<script src="../scripts/utils.js"></script>
<script src="../scripts/wsInterface.js"></script>
<script src="../objects/clsVector2D.js"></script>
<script src="../objects/clsClient.js"></script>
<script src="../objects/clsWorldView.js"></script>
<script src="../objects/clsDisplayPanel.js"></script>
<script src="../objects/clsGround.js"></script>
<script src="../objects/clsTileset.js"></script>

<script>
    // http://www.html5rocks.com/en/tutorials/dnd/basics/
    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        ev.dataTransfer.setData("text", ev.target.id);
    }

    function drop(ev) {
        ev.preventDefault();
        var data = ev.dataTransfer.getData("text");
        ev.target.appendChild(document.getElementById(data));
    }
</script>


<script type="text/javascript">

    /*******************************************************************
        Game Interface
        handles user input from the keyboard and mouse
        handles data input from the game server
    ********************************************************************/

    // gloabl data objects
    var client = new clsClient(); // client interface

    function setup() {
        
        // start game loop
        client.heartBeat = setInterval(function () { gameLoop(); }, 1000 / 10);
    }

    function JSONResponseHandler(response) {

        switch (response.callName) {
            case "getTiles":
                {
                    client.worldView.ground.displayTiles(response.content);
                    break;
                }
            default:
                {
                    console.log("ERROR: unidentified response ignored.");
                    break;
                }
        }
    }

    

    function keyDownHandler(event) {

        //alert("event.keyCode" + event.keyCode);
        //alert("event.charCode" + event.charCode);

        switch (event.keyCode) {
            case 36:
                {
                    // up left
                    client.worldView.ground.shiftTiles(-1, -1);
                    break;
                }
            case 38:
                {
                    // up
                    client.worldView.ground.shiftTiles(0, -1);
                    break;
                }
            case 33:
                {
                    // up right
                    client.worldView.ground.shiftTiles(+1, -1);
                    break;
                }
            case 37:
                {
                    // left
                    client.worldView.ground.shiftTiles(-1, 0);
                    break;
                }
            case 39:
                {
                    // right
                    client.worldView.ground.shiftTiles(+1, 0);
                    break;
                }
            case 35:
                {
                    // down left
                    client.worldView.ground.shiftTiles(-1, +1);
                    break;
                }
            case 40:
                {
                    // down
                    client.worldView.ground.shiftTiles(0, +1);
                    break;
                }
            case 34:
                {
                    // down right
                    client.worldView.ground.shiftTiles(+1, +1);
                    break;
                }
            default:
                {
                    //alert("event.keyCode" + event.keyCode);
                }
        }
    }

    function tileOnClick(elementID) {
        console.log("Clicked tile elementID '" + elementID + "'");

        var tmp = elementID.split("-");
        var screenLocation = new clsVector2D(Number(tmp[0]), Number(tmp[1]));
        var worldLocation = client.worldView.ground.screenToWorld(screenLocation);
        client.playerMoveRequest(worldLocation.x, worldLocation.y);
    }

    function gameLoop() {
        client.process();
    }

    setup();
</script>

