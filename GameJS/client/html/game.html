<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" style="background:#000000;">
<head id="Head1" runat="server">
    <title>JS Game</title>
    <link href="../styles/clsDisplayPanel.css" rel="stylesheet" />
    <link href="../styles/clsGround.css" rel="stylesheet" />
    <link href="../styles/clsContainer.css" rel="stylesheet" />
</head>
<body onkeydown="keyDownHandler(event)" ondrop="drop(event)" ondragover="allowDrop(event)">
    
</body>
</html>

<script src="../scripts/jquery-2.2.0.min.js"></script>
<script src="../scripts/utils.js"></script>
<script src="../scripts/wsInterface.js"></script>
<script src="../objects/clsVector2D.js"></script>
<script src="../objects/clsClient.js"></script>
<script src="../objects/clsWorldView.js"></script>
<script src="../objects/clsContainerView.js"></script>
<script src="../objects/clsDisplayPanel.js"></script>
<script src="../objects/clsGround.js"></script>
<script src="../objects/clsImageset.js"></script>

<!-- world objects -->
<script src="../packs/trees/trees.js"></script>
<script src="../packs/stone/stone.js"></script>



<script>
    // http://www.html5rocks.com/en/tutorials/dnd/basics/
    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        ev.dataTransfer.setData("text", ev.target.id);
    }

    function drop(ev) {
        ev.preventDefault();
        var data = ev.dataTransfer.getData("text");
        ev.target.appendChild(document.getElementById(data));
    }
</script>


<script type="text/javascript">

    /*******************************************************************
        Game Interface
        handles user input from the keyboard and mouse
        handles data input from the game server
    ********************************************************************/

    // gloabl data objects
    var client = new clsClient(); // client interface

    function setup() {

        // import world objects
        tree.import();
        stone.import();
        
        // start game loop
        //client.heartBeat = setInterval(function () { gameLoop(); }, 1500 / 10);
        client.heartBeat = setInterval(function () { gameLoop(); }, 100);
    }

    function JSONResponseHandler(response) {

        switch (response.callName) {
            case "getObject":
            case "setObject":
            case "getObjects":
                {
                    client.worldView.ground.updateObjects(response.content);
                    break;
                }
            default:
                {
                    console.log("ERROR: unidentified response ignored.");
                    break;
                }
        }
    }

    

    function keyDownHandler(event) {

        //alert("event.keyCode" + event.keyCode);
        //alert("event.charCode" + event.charCode);

        switch (event.keyCode) {
            case 36:
                {
                    // up left
                    client.playerMoveTarget = new clsVector2D(client.player.x - 1, client.player.y);
                    break;
                }
            case 38:
                {
                    // up
                    client.playerMoveTarget = new clsVector2D(client.player.x - 1, client.player.y - 1);
                    break;
                }
            case 33:
                {
                    // up right
                    client.playerMoveTarget = new clsVector2D(client.player.x, client.player.y - 1);
                    break;
                }
            case 37:
                {
                    // left
                    client.playerMoveTarget = new clsVector2D(client.player.x - 1, client.player.y + 1);
                    break;
                }
            case 39:
                {
                    // right
                    client.playerMoveTarget = new clsVector2D(client.player.x + 1, client.player.y - 1);
                    break;
                }
            case 35:
                {
                    // down left
                    client.playerMoveTarget = new clsVector2D(client.player.x, client.player.y + 1);
                    break;
                }
            case 40:
                {
                    // down
                    client.playerMoveTarget = new clsVector2D(client.player.x + 1, client.player.y + 1);
                    break;
                }
            case 34:
                {
                    // down right
                    client.playerMoveTarget = new clsVector2D(client.player.x + 1, client.player.y);
                    break;
                }
            default:
                {
                    //alert("event.keyCode" + event.keyCode);
                }
        }
    }

    function tileOnClick(element) {
        console.log("Clicked tile.");

        // get info about the click
        var screenLocation = new clsVector2D(Number(element.dataset.x), Number(element.dataset.y)); // get screen location clicked
        var worldLocation = client.worldView.ground.screenToWorld(screenLocation); // get world location clicked

        // which click type was it
        var rightclick;
        if (!e) var e = window.event;
        if (e.which) rightclick = (e.which == 3);
        else if (e.button) rightclick = (e.button == 2);


        if (rightclick == true) {
            // right click
            var br = Math.floor(Math.random() * 2);
            client.setObject(worldLocation.x, worldLocation.y,"cubes", "bedrock" + br);
        }
        else {
            // left click

            // reload with new location as center
            client.playerMoveTarget = new clsVector2D(worldLocation.x, worldLocation.y);
        }

        //return false; // don't show default right click menu
        e.preventDefault();
    }


    function gameLoop() {
        client.process();
    }

    setup();
    
</script>


